# 09. 센티널

## 고가용성 기능의 필요성

- 레디스는 인메모리 DB로, 백업을 설정하지 않은 경우 인스턴스가 재시작된다면 모든 데이터는 유실된다.
- 마스터 노드에 장애가 발생한 경우
    - 복제본을 구성한 경우라면 복제본 노드에 데이터가 남아 있을 수 있지만 클라이언트가 마스터 노드에 직접 연결된 상태라면 다음 과정을 통해 장애 상황을 복구할 수 있다.
        - 복제본 노드에 직접 접속한 뒤 `REPLICA OF NO ONE` 커맨드를 통해 읽기 전용 상태 해제
        - 애플리케이션 코드에서 레디스의 엔드포인트를 복제본의 IP로 변경
        - 배포
- 운영 환경에서 별다른 고가용성 기능 없이 마스터 노드에 장애가 발생한다면, 서비스 기능의 문제로 이어질 수 있다.
- 레디스를 look aside 구성의 캐시로 사용하는 경우 캐시에 접근할 수 없다면?
    - 데이터를 요청하는 모든 세션들이 원본 소스에 집중되면 서버의 부하가 급증한다.
    - 급격한 커넥션 증가는 운영 중인 서비스에 영향을 끼칠 수 있다.

## 센티널(Sentinel)이란?

- 레디스 자체 고가용성 기능이다.
- 기존 레디스와는 다른 역할을 하는 별도의 프로그램으로 센티널을 사용하면 자동 페일오바와 같이 장애 상황을 대비할 수 있다.

### 센티널 기능

- 모니터링
    - 마스터, 복제본 노드의 상태를 실시간으로 확인한다.
- 자동 페일오버
    - 마스터 노드의 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격시킨다.
    - 기존 마스터 노드에 연결된 복제본은 새로 승격된 마스터 노드에 연결된다.
- 인스턴스 구성 정보 안내
    - 센티널은 클라이언트에게 현재 구성에서 마스터 정보를 제공한다.
    - 페일오버가 발생해도 변경된 마스터 정보를 재전달하여 레디스의 엔드포인트 정보를 변경할 필요가 없다.

### 분산 시스템으로 동작하는 센티널

- SPOF(Single Point Of Failure)
    - 하나의 문제가 발생했을 때 전체 시스템이 영향을 받는 지점
- 레디스가 SPOF가 되는것을 방지하기 위해 센티널을 도입한다.
- 센티널은 그 자체로 SPOF가 되기위해 최소 3대 이상으로 구성한다.
    - 하나의 센티널에 이상이 생겨도 다른 센티널이 계속해서 역할을 수행할 수 있다.
- 쿼럼(Quorum)이라는 개념을 통해 오탐을 줄인다.
    - 쿼럼은 마스터 노드가 비정상 동작을 한다는 것에 동의해야 하는 센티널 수를 의미한다.
    - 쿼럼을 만족하는 경우 페일오버를 시작한다.
- 센티널을 쿼럼을 시용한 과반수 선출 개념을 사용하기 때문에 홀수로 구성하는 것이 좋다.

### 센티널 인스턴스 배치 방법

- 물리적으로 서로 영향받지 도록 서로 다른 가용 영역에 배치한다.
- 일반적으로 하나의 서버에 레디스 프로세스와 센티널 프로세스를 동시에 실행시킨다.
- 마스터 노드에 문제가 생기면, 센티널 인스턴스의 판단으로 자동으로 다음 과정이 진행된다.
    - 쿼럼을 만족하는 경우 페일오버를 진행시킨다.
    - 센티널 인스턴스는 새로운 마스터 노드를 선출한 뒤, 복제본을 마스터 노드로 승격 시킨다.
    - 기존 마스터 노드를 바라보던 복제본과 클라이언트는 새로 선출된 마스터 노드로 연결된다.
    - 기존 마스터 노드가 복구된다면 새로 선출된 마스터 노드의 복제본이 되도록 연결시킨다.
- 1개의 복제본으로 충분한 경우, 나머지 1대의 서버에는 센티널 프로세스만 실행하도록 배치할 수 있다.
    - 센티널만 실행될 서버는 마스터 노드의 비정상 동작에 동의하는 역할만 하게된다.
